version: "3.9"

services:
  api_build:
    build:
      context: .
      dockerfile: Dockerfile
    image: lab_api_build:latest
    command: ["sh", "-c", "echo Build conclu√≠do com sucesso!"]

  api_test:
    build:
      context: .
      dockerfile: Dockerfile
    image: lab_api_test:latest
    depends_on:
      - api_build
    volumes:
      - .:/app
    working_dir: /app
    command: ["python", "-m", "unittest", "discover", "-v"]

  api:
    build:
      context: .
      dockerfile: Dockerfile
    image: lab_api:latest
    container_name: lab_api_container
    depends_on:
      - api_test
    ports:
      - "1313:1313"
    volumes:
      - .:/app
    environment:
      FLASK_ENV: production
    command: ["python", "app.py"]
    restart: unless-stopped
